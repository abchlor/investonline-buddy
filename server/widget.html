<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>InvestOnline Buddy</title>

<!-- Load Recaptcha V3 -->
<script src="https://www.google.com/recaptcha/api.js?render=6LcdNyIsAAAAADuObE98pa6KC4g9HG-FirZ7Ohro"></script>

<!-- Load CryptoJS for HMAC -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
  :root{
    --brand:#F58220;
    --brand-600:#e06f05;
    --bg:#f6f7fb;
    --muted:#6b7280;
    --card:#ffffff;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;}
  body{background:var(--bg);display:flex;flex-direction:column;overflow:hidden}

  .shell{width:100%;height:100%;display:flex;flex-direction:column;border-radius:10px;overflow:hidden;background:#fff}

  .header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card);border-bottom:1px solid #eef2f7}
  .avatar-wrap{width:44px;height:44px;border-radius:10px;overflow:hidden;flex:0 0 44px;background:#fff;display:flex;align-items:center;justify-content:center}
  .title{font-weight:700;color:#0f172a;font-size:16px}
  .subtitle{font-size:12px;color:var(--muted)}

  .chat{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:10px}

  .msg{max-width:78%;padding:12px 14px;border-radius:12px;font-size:14px;line-height:1.5}
  .bot{align-self:flex-start;background:#fff;border:1px solid #eef2f7;color:#0f172a}
  .user{align-self:flex-end;background:var(--brand);color:#fff}

  /* Make links in bot messages visible */
  .bot a{color:var(--brand);text-decoration:underline;font-weight:500}
  .bot a:hover{color:var(--brand-600)}

  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .chip{background:rgba(245,130,32,0.08);border:1px solid rgba(245,130,32,0.12);color:var(--brand-600);padding:8px 12px;border-radius:20px;font-size:13px;cursor:pointer;transition:all 0.2s}
  .chip:hover{background:rgba(245,130,32,0.15);transform:translateY(-1px)}

  .typing{display:flex;align-items:center;gap:6px}
  .dot{width:7px;height:7px;border-radius:50%;background:#b9c3d3;animation:typing 1.2s infinite}
  .dot:nth-child(2){animation-delay:.15s}
  .dot:nth-child(3){animation-delay:.3s}
  @keyframes typing{
    0%{opacity:.2;transform:translateY(0)}
    50%{opacity:1;transform:translateY(-3px)}
    100%{opacity:.2;transform:translateY(0)}
  }

  .input-area{display:flex;gap:10px;padding:12px;border-top:1px solid #edf2f7;background:#fff}
  .input{flex:1;padding:12px 14px;border-radius:999px;border:1px solid #e6eef7;font-size:14px;outline:none}
  .input:focus{border-color:var(--brand)}
  .btn{background:var(--brand);border:none;color:#fff;padding:10px 20px;border-radius:999px;font-weight:600;cursor:pointer;transition:all 0.2s}
  .btn:hover{background:var(--brand-600);transform:scale(1.02)}
  .btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
</style>
</head>

<body>
<div class="shell">
  <div class="header">
    <div class="avatar-wrap">
      <svg width="44" height="44" viewBox="0 0 120 120" fill="none">
        <rect width="120" height="120" rx="18" fill="#F58220"/>
        <text x="60" y="80" text-anchor="middle" fill="white" font-size="60" font-weight="bold">IO</text>
      </svg>
    </div>
    <div>
      <div class="title">InvestOnline Buddy</div>
      <div class="subtitle">Ask about investments, KYC & onboarding</div>
    </div>
  </div>

  <div class="chat" id="chat">
    <div class="msg bot">Hi — I'm InvestOnline Buddy. How can I help you today?</div>

    <div class="chips" id="welcomeChips">
      <div class="chip" onclick="pick('Start Registration')">Start Registration</div>
      <div class="chip" onclick="pick('What is KYC?')">What is KYC?</div>
      <div class="chip" onclick="pick('Documents Needed')">Documents Needed</div>
      <div class="chip" onclick="pick('Talk to Support')">Talk to Support</div>
    </div>
  </div>

  <div class="input-area">
    <input id="userInput" class="input" placeholder="Type your question..." />
    <button class="btn" id="sendBtn">Send</button>
  </div>
</div>

<script>
/* CONFIG */
const WIDGET_API_BASE = "https://investonline-buddy.onrender.com";
const RECAPTCHA_SITE_KEY = "6LcdNyIsAAAAADuObE98pa6KC4g9HG-FirZ7Ohro";

/* STATE */
let sessionToken = null;
let clientKey = null;
let sessionId = `sess_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
let isProcessing = false;

/* ELEMENTS */
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

function appendMessage(text, who="bot"){
  const d = document.createElement("div");
  d.className = "msg " + who;
  
  // For bot messages, render HTML (for links)
  if (who === "bot") {
    d.innerHTML = text;
  } else {
    d.innerText = text;
  }
  
  chatEl.appendChild(d);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function appendChips(list){
  if(!list || list.length === 0) return;
  const wrap = document.createElement("div");
  wrap.className = "chips";
  list.forEach(label=>{
    const c = document.createElement("div");
    c.className = "chip";
    c.innerText = label;
    c.onclick = ()=>{ inputEl.value = label; sendMessage(); };
    wrap.appendChild(c);
  });
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function showTyping(){
  const t=document.createElement('div');
  t.className='msg bot';
  t.id='typing';
  t.innerHTML='<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
  chatEl.appendChild(t);
  chatEl.scrollTop=chatEl.scrollHeight;
}

function hideTyping(){
  const t = document.getElementById("typing");
  if(t) t.remove();
}

function hideElement(id){
  const el = document.getElementById(id);
  if(el) el.style.display="none";
}

function pick(text){
  inputEl.value = text;
  sendMessage();
}

/* SIGNING FUNCTION - Uses CryptoJS */
function signRequest(timestamp, bodyObject, clientKeyHex){
  // Server expects: HMAC-SHA256(clientKey, "timestamp.bodyJSON")
  const bodyJSON = JSON.stringify(bodyObject);
  const payload = `${timestamp}.${bodyJSON}`;
  
  // Parse hex key and sign
  const key = CryptoJS.enc.Hex.parse(clientKeyHex.toLowerCase());
  const hmac = CryptoJS.HmacSHA256(payload, key);
  return hmac.toString(CryptoJS.enc.Hex);
}

/* RECAPTCHA TOKEN */
async function getRecaptchaToken(key){
  return grecaptcha.execute(key, { action: "chat" });
}

/* START SESSION */
async function startSession(){
  try {
    const res = await fetch(`${WIDGET_API_BASE}/session/start`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session_id: sessionId })
    });

    const j = await res.json();
    if(j.ok){
      sessionToken = j.session_token;
      clientKey = j.client_key;
      console.log("✅ Session started successfully");
    } else {
      console.error("❌ Session start failed", j);
    }
  } catch (err){
    console.error("❌ Session error", err);
  }
}

/* SEND MESSAGE */
async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text || isProcessing) return;

  // Check if session is ready
  if(!sessionToken || !clientKey){
    console.error("Session not ready. Retrying...");
    await startSession();
    if(!sessionToken || !clientKey){
      appendMessage("Please wait, initializing...", "bot");
      return;
    }
  }

  isProcessing = true;
  sendBtn.disabled = true;
  
  appendMessage(text, "user");
  inputEl.value = "";
  hideElement("welcomeChips");
  showTyping();

  const timestamp = Date.now().toString();
  const requestBody = {
    session_id: sessionId,
    message: text
  };

  // Generate signature
  const signature = signRequest(timestamp, requestBody, clientKey);
  const recaptchaToken = await getRecaptchaToken(RECAPTCHA_SITE_KEY);

  try {
    // Add 30 second timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000);

    const res = await fetch(`${WIDGET_API_BASE}/chat`, {
      method: "POST",
      signal: controller.signal,
      headers: {
        "Content-Type": "application/json",
        "X-Session-Token": sessionToken,
        "X-Timestamp": timestamp,
        "X-Signature": signature,
        "X-Recaptcha-Token": recaptchaToken
      },
      body: JSON.stringify(requestBody)
    });

    clearTimeout(timeoutId);

    const j = await res.json();
    hideTyping();

    if(res.ok){
      appendMessage(j.reply || "Got it!", "bot");
      appendChips(j.suggested);
    } else {
      // Handle 401 - session expired
      if(res.status === 401 && j.error === "invalid_session_token"){
        console.log("Session expired, refreshing...");
        await startSession();
        appendMessage("Session refreshed. Please try again.", "bot");
      } else {
        appendMessage(j.error || "Something went wrong. Please try again.", "bot");
        console.error("Chat error:", j);
      }
    }

  } catch(err){
    hideTyping();
    if (err.name === 'AbortError') {
      appendMessage("⏱️ Request timed out. Please try a simpler question or contact support at 1800-2222-65.", "bot");
    } else {
      appendMessage("Network issue. Please check your connection and try again.", "bot");
    }
    console.error("❌ Chat error", err);
  } finally {
    isProcessing = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }
}

sendBtn.addEventListener("click", sendMessage);
inputEl.addEventListener("keydown", e=>{
  if(e.key === "Enter" && !isProcessing) sendMessage();
});

/* INIT */
startSession();
</script>
</body>
</html>
